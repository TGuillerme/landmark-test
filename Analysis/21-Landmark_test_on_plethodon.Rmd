---
title: "Step by step landmark test"
author: "Thomas Guillerme"
bibliography: references.bib
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 12
    fig_height: 6
---

```{r, message = FALSE, warning = FALSE}
## Loading the libraries (and installing if necessary)
if(!require(devtools)) install.packages("devtools")
if(!require(knitr)) install.packages("knitr")
if(!require(geomorph)) install.packages("geomorph")
if(!require(dispRity)) install.packages("dispRity");library(dispRity)
if(!require(landmarktest)) install_github("TGuillerme/landmark-test");library(landmarktest)
source("../Functions/utilities.R")
set.seed(1)
```

# Step by step landmark test

This is a step by step analysis on the `geomorph` `plethodon` dataset to show visualise the landmark test.

## Loading the data and setting up the partitions

Here we are going to work on the plethodon dataset that contains 40 specimen with 12 landmarks each.
We are going to divide the landmarks into two categories: the back of the skull (5 landmarks) and the front of the skull (6 landmarks).

Eventually we are going to test whether one partition changes significantly more than the other.

```{r, fig.width = 6, fig.height = 6}
## Loading the data
data(plethodon)

## Procrustes superimposition
procrustes <- gpagen(plethodon$land, print.progress = FALSE)

## Selecting the landmarks
back <- c(1,2,10,11,12)
front <- c(1:12)[-back]

cols <- rep(NA, 12)
cols[back] <- "blue"
cols[front] <- "orange"
## Plotting the landmarks
par(bty = "n")
plot(procrustes$consensus, xlim = c(-0.6, 0.6), ylim = c(-0.6, 0.6), pch = 19, xaxt = "n",
     yaxt = "n", xlab = "", ylab = "", main = "Consensus shape", col = cols)
text(procrustes$consensus, labels = c(1:12), adj = 2)
```

And we can represent each individual specimen's variation in landmark position from the consensus shape


```{r, fig.width = 12, fig.height = 19.2, echo = FALSE}
par(mfrow = c(8,5), bty = "n", mar = c(0,0,0,0))
for(spec in 1:dim(plethodon$land)[3]) {
    ## Plot the variation
    plotRefToTarget(procrustes$consensus, procrustes$coords[,, spec], method = "vector", mag = 2)
    ## Colour the points
    points(procrustes$consensus, col = cols, pch = 19, cex = 1.2)
    ## Add the specimen number
    text(0, 0.4, paste("Specimen", spec), cex = 1)
}
```


## Measuring the range of variation

Now for each specimen, we can measure the range of landmark variation from the consensus shape.
In other words, this is the length of the vectors of changes plotted above.

From these vectors of changes, we want to measure the range of variation, i.e. selecting the two skulls with the most different landmark positions.
Here, the landmark difference is calculated using the spherical coordinates between each landmark for each pair of species.
The spherical coordinates are a coordinate system measured in a sphere composed of the length ($\rho$, the euclidean distance between the two landmarks) the azimuth angle ($\phi$, the angle on the equatorial plan) and the polar angle ($\theta$, the angle measured on the polar plan).
Since we are only interested in the _magnitude_ of difference ($\rho$) regardless of the direction ($\phi$ and $\theta$) we will use only the length below.

We calculate the to extremes (the two individuals with the most different radii) using the following simple algorithm:

 1. Calculate the radii for all _n_ landmarks between the mean Procrustes superimposition and each individual superimposition.
 2. Rank each set of _n_ radii and measure the area under the resulting curve.
 3. Select the specimen with the highest _n_ radii area. This is now the "maximum" Procrustes (i.e. the specimen with the most different shape compared to the mean).
 4. Calculate the radii for all _n_ landmarks between the "maximum" Procrustes and the remaining individual ones.
 5. Repeat step 2 and 3. The result specimen with the highest _n_ radii area is now the "minimum" Procrustes (i.e. the specimen with the most different shape compared to the "maximum" Procrustes).

These two "maximum" and "minimum" Procrustes are not the biggest/smallest, widest/narowest, etc. skulls _per se_ but rather the two extremes of the overall distribution of landmark variation ($\rho$).
Without visualisation, it actually impossible to even determine which one between the "maximum" or the "minimum" has actually the most variation.
However, since we are not interest in direction, this is totally sufficient to give us the magnitude of differences between specimens (while taking into account _all_ the landmarks the three dimensions).

This procedure can be compute with the `variation.range` function:


```{r}
## Variation range
procrustes_var <- variation.range(procrustes, type = "spherical", what = "radius", return.ID = TRUE)
```

```{r, fig.width = 8, fig.height = 8, echo = FALSE}
## The difference between each specimen and the consensus shape
M0 <- procrustes$consensus
M1 <- procrustes$coords[,, procrustes_var$min.max[1]]
M2 <- procrustes$coords[,, procrustes_var$min.max[2]]

## The difference between all specimens
par(bty = "n")
plot(M0, xlim = c(-0.3, 0.6), ylim = c(-0.3, 0.3), pch = 19, xaxt = "n", yaxt = "n", xlab = "",
     ylab = "", main = "Variation range", col = "grey", cex = 0.5)


## Distances between the consensus and the extremes
for(land in 1:dim(plethodon$land)[1]) {
    lines(x = c(M0[land, 1], M1[land, 1]), y = c(M0[land, 2], M1[land, 2]), col = "blue")
    lines(x = c(M0[land, 1], M2[land, 1]), y = c(M0[land, 2], M2[land, 2]), col = "orange")
}
points(procrustes$consensus, col = "grey", pch = 19, cex = 0.5)

## Distances between the extremes
for(land in 1:dim(plethodon$land)[1]) {
    lines(x = c(M1[land, 1], M2[land, 1]), y = c(M1[land, 2], M2[land, 2]))
}
## Extreme points
points(M1, col = "blue", pch = 19, cex = 0.5)
points(M2, col = "orange", pch = 19, cex = 0.5)

legend(legend = c("Consensus", paste("Specimen", procrustes_var$min.max[1]),
      paste("Specimen", procrustes_var$min.max[2])), "topleft", bty = "n",
      col = c("grey", "blue", "orange"), pch = 19)
```

The black lines in the graph above represent the maximum range of variation between all specimen.
We can then rerun the same analysis but using difference confidence intervals.


```{r}
## Variation range with confidence intervals
var_range_95_hdr <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.95, CI.hdr = TRUE)
var_range_75_hdr <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.75, CI.hdr = TRUE)
var_range_50_hdr <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.5, CI.hdr = FALSE)
var_range_95 <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.95, CI.hdr = FALSE)
var_range_75 <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.75, CI.hdr = FALSE)
var_range_50 <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.6, CI.hdr = FALSE)


## Variation range with confidence intervals
var_range_95_hdr_pre <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.95, CI.hdr = TRUE, CI.pre = TRUE)
var_range_75_hdr_pre <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.75, CI.hdr = TRUE, CI.pre = TRUE)
var_range_50_hdr_pre <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.6, CI.hdr = FALSE, CI.pre = TRUE)
var_range_95_pre <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.95, CI.hdr = FALSE, CI.pre = TRUE)
var_range_75_pre <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.75, CI.hdr = FALSE, CI.pre = TRUE)
var_range_50_pre <- variation.range(procrustes, type = "spherical", what = "radius",
                                    return.ID = TRUE, CI = 0.6, CI.hdr = FALSE, CI.pre = TRUE)

```

Or, to compare them more easily:


```{r, fig.width = 12, fig.height = 12, echo = FALSE}
par(bty = "n", mfrow = c(2,2))
C100 <- procrustes_var
C95 <- var_range_95
C75 <- var_range_75
C50 <- var_range_50
## Getting the ranges histograms
plot(sort(C100$range[, "radius"], decreasing = TRUE), type = "l", ylim = c(0, 0.1),
     xlab = "ranked landmarks", ylab = "landmark difference", main = "Variation range ranking (no hdr)")
lines(sort(C95$range[, "radius"], decreasing = TRUE), col = "orange")
lines(sort(C75$range[, "radius"], decreasing = TRUE), col = "blue")
lines(sort(C50$range[, "radius"], decreasing = TRUE), col = "darkgreen")
legend("topright", bty = "n", lty = 1, col = c("black", "orange", "blue", "darkgreen"), 
    legend = c(paste0("100% CI (", paste0(C100$min.max, collapse = ", "), ")"),
               paste0("95% CI (", paste0(C95$min.max, collapse = ", "), ")"),
               paste0("75% CI (", paste0(C75$min.max, collapse = ", "), ")"),
               paste0("60% CI (", paste0(C50$min.max, collapse = ", "), ")")))


C95 <- var_range_95_hdr
C75 <- var_range_75_hdr
C50 <- var_range_50_hdr
## Getting the ranges histograms
plot(sort(C100$range[, "radius"], decreasing = TRUE), type = "l", ylim = c(0, 0.1),
     xlab = "ranked landmarks", ylab = "landmark difference", main = "Variation range ranking (with hdr)")
lines(sort(C95$range[, "radius"], decreasing = TRUE), col = "orange")
lines(sort(C75$range[, "radius"], decreasing = TRUE), col = "blue")
lines(sort(C50$range[, "radius"], decreasing = TRUE), col = "darkgreen")
legend("topright", bty = "n", lty = 1, col = c("black", "orange", "blue", "darkgreen"), 
    legend = c(paste0("100% CI (", paste0(C100$min.max, collapse = ", "), ")"),
               paste0("95% CI (", paste0(C95$min.max, collapse = ", "), ")"),
               paste0("75% CI (", paste0(C75$min.max, collapse = ", "), ")"),
               paste0("60% CI (", paste0(C50$min.max, collapse = ", "), ")")))


## Getting the ranges histograms
C95 <- var_range_95_pre
C75 <- var_range_75_pre
C50 <- var_range_50_pre
plot(sort(C100$range[, "radius"], decreasing = TRUE), type = "l", ylim = c(0, 0.1),
     xlab = "ranked landmarks", ylab = "landmark difference", main = "Variation range ranking (no hdr ; pre CI)")
lines(sort(C95$range[, "radius"], decreasing = TRUE), col = "orange")
lines(sort(C75$range[, "radius"], decreasing = TRUE), col = "blue")
lines(sort(C50$range[, "radius"], decreasing = TRUE), col = "darkgreen")
legend("topright", bty = "n", lty = 1, col = c("black", "orange", "blue", "darkgreen"), 
    legend = c(paste0("100% CI (", paste0(C100$min.max, collapse = ", "), ")"),
               paste0("95% CI (", paste0(C95$min.max, collapse = ", "), ")"),
               paste0("75% CI (", paste0(C75$min.max, collapse = ", "), ")"),
               paste0("60% CI (", paste0(C50$min.max, collapse = ", "), ")")))

## Getting the ranges histograms
C95 <- var_range_95_hdr_pre
C75 <- var_range_75_hdr_pre
C50 <- var_range_50_hdr_pre
plot(sort(C100$range[, "radius"], decreasing = TRUE), type = "l", ylim = c(0, 0.1),
     xlab = "ranked landmarks", ylab = "landmark difference", main = "Variation range ranking (with hdr pre CI)")
lines(sort(C95$range[, "radius"], decreasing = TRUE), col = "orange")
lines(sort(C75$range[, "radius"], decreasing = TRUE), col = "blue")
lines(sort(C50$range[, "radius"], decreasing = TRUE), col = "darkgreen")
legend("topright", bty = "n", lty = 1, col = c("black", "orange", "blue", "darkgreen"), 
    legend = c(paste0("100% CI (", paste0(C100$min.max, collapse = ", "), ")"),
               paste0("95% CI (", paste0(C95$min.max, collapse = ", "), ")"),
               paste0("75% CI (", paste0(C75$min.max, collapse = ", "), ")"),
               paste0("60% CI (", paste0(C50$min.max, collapse = ", "), ")")))

```



We can also 
And represent them in the same way:


```{r, fig.width = 8, fig.height = 24, echo = FALSE}
par(bty = "n", mfrow = c(3,1))

## The difference between each specimen and the consensus shape
M0 <- procrustes$consensus
M1 <- procrustes$coords[,, var_range_95$min.max[1]]
M2 <- procrustes$coords[,, var_range_95$min.max[2]]

## The difference between all specimens
plot(M0, xlim = c(-0.3, 0.6), ylim = c(-0.3, 0.3), pch = 19, xaxt = "n", yaxt = "n", xlab = "",
     ylab = "", main = "Variation range (95%)", col = "grey", cex = 0.5)


## Distances between the consensus and the extremes
for(land in 1:dim(plethodon$land)[1]) {
    lines(x = c(M0[land, 1], M1[land, 1]), y = c(M0[land, 2], M1[land, 2]), col = "blue")
    lines(x = c(M0[land, 1], M2[land, 1]), y = c(M0[land, 2], M2[land, 2]), col = "orange")
}
points(procrustes$consensus, col = "grey", pch = 19, cex = 0.5)

## Distances between the extremes
for(land in 1:dim(plethodon$land)[1]) {
    lines(x = c(M1[land, 1], M2[land, 1]), y = c(M1[land, 2], M2[land, 2]))
}
## Extreme points
points(M1, col = "blue", pch = 19, cex = 0.5)
points(M2, col = "orange", pch = 19, cex = 0.5)

legend(legend = c("Consensus", paste("Specimen", procrustes_var$min.max[1]),
      paste("Specimen", procrustes_var$min.max[2])), "topleft", bty = "n",
      col = c("grey", "blue", "orange"), pch = 19)

## The difference between each specimen and the consensus shape
M0 <- procrustes$consensus
M1 <- procrustes$coords[,, var_range_75$min.max[1]]
M2 <- procrustes$coords[,, var_range_75$min.max[2]]

## The difference between all specimens
plot(M0, xlim = c(-0.3, 0.6), ylim = c(-0.3, 0.3), pch = 19, xaxt = "n", yaxt = "n", xlab = "",
     ylab = "", main = "Variation range (75%)", col = "grey", cex = 0.5)


## Distances between the consensus and the extremes
for(land in 1:dim(plethodon$land)[1]) {
    lines(x = c(M0[land, 1], M1[land, 1]), y = c(M0[land, 2], M1[land, 2]), col = "blue")
    lines(x = c(M0[land, 1], M2[land, 1]), y = c(M0[land, 2], M2[land, 2]), col = "orange")
}
points(procrustes$consensus, col = "grey", pch = 19, cex = 0.5)

## Distances between the extremes
for(land in 1:dim(plethodon$land)[1]) {
    lines(x = c(M1[land, 1], M2[land, 1]), y = c(M1[land, 2], M2[land, 2]))
}
## Extreme points
points(M1, col = "blue", pch = 19, cex = 0.5)
points(M2, col = "orange", pch = 19, cex = 0.5)

legend(legend = c("Consensus", paste("Specimen", procrustes_var$min.max[1]),
      paste("Specimen", procrustes_var$min.max[2])), "topleft", bty = "n",
      col = c("grey", "blue", "orange"), pch = 19)

## The difference between each specimen and the consensus shape
M0 <- procrustes$consensus
M1 <- procrustes$coords[,, var_range_50$min.max[1]]
M2 <- procrustes$coords[,, var_range_50$min.max[2]]

## The difference between all specimens
plot(M0, xlim = c(-0.3, 0.6), ylim = c(-0.3, 0.3), pch = 19, xaxt = "n", yaxt = "n", xlab = "",
     ylab = "", main = "Variation range (50%)", col = "grey", cex = 0.5)


## Distances between the consensus and the extremes
for(land in 1:dim(plethodon$land)[1]) {
    lines(x = c(M0[land, 1], M1[land, 1]), y = c(M0[land, 2], M1[land, 2]), col = "blue")
    lines(x = c(M0[land, 1], M2[land, 1]), y = c(M0[land, 2], M2[land, 2]), col = "orange")
}
points(procrustes$consensus, col = "grey", pch = 19, cex = 0.5)

## Distances between the extremes
for(land in 1:dim(plethodon$land)[1]) {
    lines(x = c(M1[land, 1], M2[land, 1]), y = c(M1[land, 2], M2[land, 2]))
}
## Extreme points
points(M1, col = "blue", pch = 19, cex = 0.5)
points(M2, col = "orange", pch = 19, cex = 0.5)

legend(legend = c("Consensus", paste("Specimen", procrustes_var$min.max[1]),
      paste("Specimen", procrustes_var$min.max[2])), "topleft", bty = "n",
      col = c("grey", "blue", "orange"), pch = 19)
```


