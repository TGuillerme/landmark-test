---
title: "Landmark region difference (data)"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 12
    fig_height: 6
---

```{r}
## Loading the libraries (and installing if necessary)
if(!require(geomorph)) install.packages("geomorph")
```

This script reads in the data and saves it in the proper format to be analysed

## Inputs

The data should be stored in `../Data/` in the following format:

Data type | Data set | Species | File format
----------|----------|---------|------------
classification | cranium  | sp1 | .csv
landmarkgroups | mandible | sp2 |
landmarkdata   |          | sp3 |


### Data per species

```{r}
## The chain names
chains <- c("sp1", "sp2", "sp3")

## The chain place holder
all_chains <- list()

## Looping through the chains
for(chain in chains) {
    
    ## The datasets
    datasets <- c("cranium", "mandible")

    ## Output list holder
    output_list <- list()

    ## Looping through the datasets
    for(dataset in datasets) {

        ## Read the landmarks groups
        output_list[[dataset]][[1]] <- read.csv(paste0("../Data/landmarkgroups_", dataset, "_",
                                                chain, ".csv"))
        
        ## Read the landmarks
        output_list[[dataset]][[2]] <- t(read.csv(paste0("../Data/landmarkdata_", dataset, "_",
                                                  chain, ".csv") , header = TRUE, row.names = 1))
        
        ## Remove any NAs rows
        output_list[[dataset]][[2]] <- output_list[[dataset]][[2]][complete.cases(
                                                                   output_list[[dataset]][[2]]),]
        
        ## Make into a 3D array
        output_list[[dataset]][[2]] <- geomorph::arrayspecs(output_list[[dataset]][[2]], k = 3,
                                                            p = ncol(output_list[[dataset]][[2]])/3)

        ## Running the Procrustes superimposition
        output_list[[dataset]][[3]] <- geomorph::gpagen(output_list[[dataset]][[2]],
                                                        print.progress = FALSE)

        ## Convert the array in 2D
        array_2d <- geomorph::two.d.array(output_list[[dataset]][[3]]$coords)

        ## measure the tolerance
        tol <- prcomp(array_2d)$sdev^2
        tolerance <- cumsum(tol)/sum(tol)
        tolerance <- length(which(tolerance < 1)) 
        if(length(tolerance) < length(tol)){
            tolerance <- tolerance + 1
        }
        tolerance <- max(c(tol[tolerance]/tol[1],0.005))

        ## Ordinating the data
        output_list[[dataset]][[4]] <- prcomp(array_2d, center = TRUE, scale. = FALSE, retx = TRUE,
                                              tol = tolerance)

        ## Name the elements
        names(output_list[[dataset]]) <- c("landmarkgroups", "landmarkdata", "procrustes",
                                           "ordination")
    }

    ## Save the file
    save(output_list, file = paste0("../Data/Processed/", chain, ".Rda"))
    all_chains[[chain]] <- output_list
}
```
### Combined data