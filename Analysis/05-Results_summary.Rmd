---
title: "Landmark region difference"
author: "Thomas Guillerme"
bibliography: references.bib
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 12
    fig_height: 6
---

```{r, message = FALSE, warning = FALSE}
## Loading the libraries (and installing if necessary)
if(!require(devtools)) install.packages("devtools")
if(!require(knitr)) install.packages("knitr")
if(!require(xtable)) install.packages("xtable")
if(!require(geomorph)) install.packages("geomorph")
if(!require(dispRity)) install.packages("dispRity")
if(!require(landvR)) install_github("TGuillerme/landvR")
source("../Functions/utilities.R")
set.seed(42)
```

# Results summary


First we'll load the different results:

```{r}
## Loading and saving paths
load_path <- "../Data/Results/"
table_path <- "../Manuscript/Tables/"
figure_path <- "../Manuscript/Figures/"

## Loading the mean results (observed)
mean_results_obs <- summarise.results(CI = "mean", rarefaction = FALSE, rounding = 4)
mean_results_rar <- summarise.results(CI = "mean", rarefaction = TRUE, rounding = 4)

## Loading the extreme results (observed)
species_results_100_obs <- summarise.results(CI = 100, rarefaction = FALSE, rounding = 4)
species_results_095_obs <- summarise.results(CI = 95, rarefaction = FALSE, rounding = 4)
species_results_100_rar <- summarise.results(CI = 100, rarefaction = TRUE, rounding = 4)
species_results_095_rar <- summarise.results(CI = 95, rarefaction = TRUE, rounding = 4)
```

And combine them together into one observed table and one rarefied table:

```{r}
## Combining results
combine.results <- function(table_mean, table_100, table_95) {
    complete_fable <- rbind(table_mean[c(1:4),],
                            table_mean[c(5:8),],
                            table_100[c(9:12),], # Change to 1:4, etc. ?
                            table_95[c(9:12),],
                            table_100[c(13:16),],
                            table_95[c(13:16),],
                            table_100[c(17:20),],
                            table_95[c(17:20),])
    complete_fable <- as.data.frame(complete_fable)
    ## Make the columns numeric!
    complete_fable[, -1] <- apply(complete_fable[, -1], 2, as.numeric)

    return(complete_fable)
}

## Observed results table
complete_results_obs <- combine.results(mean_results_obs,
                                        species_results_100_obs,
                                        species_results_095_obs)

## Rarefied results table
complete_results_rar <- combine.results(mean_results_rar,
                                        species_results_100_rar,
                                        species_results_095_rar)
```

And from there we can make the latex results tables:

```{r, eval = FALSE}
## Partition names
partitions <- c("Zygomatic Arch", "Tip of snout", "Remainder(C)", "Masticatory insertions",
                "Symphyseal area", "Remainder(M)")

## Test names
test_names <- c("Vombatus vs. Lasiorhinus", "L. krefftii vs. L. latifrons",
                "Lasiorhinus krefftii (100\\%)", "Lasiorhinus krefftii (95\\%)",
                "Lasiorhinus latifrons (100\\%)", "Lasiorhinus latifrons (95\\%)",
                "Vombatus usrinus (100\\%)", "Vombatus usrinus (95\\%)")

## The table caption
caption_table <- "\"diff\" is the difference in landmark length between the ones from the partition
and all the other. \"overlap\" is the probability of overlap between the distribution of the landmark
lengths in the partitions and all the other. Because of the number of bootstrap pseudo-replicates
involved in the test (1000) and the number of tests, we lowered our threshold for rejecting H0 to p
<= 0.001. Signif. codes: 0 '*' 0.001 ' ' 1"

## Compile the latex tables
xtable.results(complete_results_obs, partitions.names = partitions, test.names = test_names,
    path = table_path, file.name = "landmark_displacement_obs", caption = caption_table)
xtable.results(complete_results_rar, partitions.names = partitions, test.names = test_names,
    path = table_path, file.name = "landmark_displacement_rar", caption = caption_table)
```

And the finalised fable:

```{r, width = 7.2, height = 4.5}
## Get the y/x labels
xlabs <- c("Zygomatic Arch", "Tip of snout", "Remainder", "Masticatory\ninsertions", "Symphyseal\narea", "Remainder")
ylabs <- c(expression(italic("Lasiorhinus vs. Vombatus")),
            expression(italic("L. krefftii vs. L. latifrons")),
            expression(paste(italic("Lasiorhinus krefftii"), "(100%)")),
            expression(paste(italic("Lasiorhinus krefftii"), "(95%)")),
            expression(paste(italic("Lasiorhinus latifrons"), "(100%)")),
            expression(paste(italic("Lasiorhinus latifrons"), "(95%)")),
            expression(paste(italic("Vombatus ursinus"), "(100%)")),
            expression(paste(italic("Vombatus ursinus"), "(95%)")))

plot.test.results(complete_results_obs, complete_results_rar, p.value = 0.001,
                  no.rar = c(2,5), xlabs = xlabs, ylabs = ylabs, digits = 3)
```

```{r, echo = FALSE}
pdf(file = "../Manuscript/Figures/landmark_test_results_full.pdf", width = 12.2, height = 4.5)
plot.test.results(complete_results_obs, complete_results_rar, p.value = 0.001, no.rar = c(2,5), xlabs = xlabs, ylabs = ylabs, digits = 3)
dev.off()
```

Non-significant differences are in grey; significant differences that could not be distinguished from the full statistical population (Bhattacharrya Coefficient test _p_-value > 0.01) are in purple; significant differences that are also from a significant statistical population are in green. Squared cells have the same significance levels when rarefied. The displayed values are the difference in landmark variation area in the partition compared to the whole cranium or mandible.
